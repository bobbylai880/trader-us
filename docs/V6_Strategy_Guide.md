# V6 "Neuro-Adaptive" 策略指南

> **AI 增强型趋势跟踪 + 宏观事件驱动**

---

## 版本历史

| 版本 | 日期 | 状态 | 收益率 | 说明 |
|------|------|------|--------|------|
| V6.0 | 2026-01-21 | ❌ 废弃 | -10.6% | 存在5个核心逻辑漏洞 |
| **V6.1** | 2026-01-21 | ✅ 可用 | **+90.4%** | 修复所有漏洞，性能恢复正常 |

---

## 目录

1. [策略概览](#策略概览)
2. [V6.0 问题诊断](#v60-问题诊断)
3. [V6.1 修复方案](#v61-修复方案)
4. [系统架构](#系统架构)
5. [回测结果对比](#回测结果对比)
6. [核心组件详解](#核心组件详解)
7. [使用指南](#使用指南)

---

## 策略概览

### 设计目标

V6 策略旨在解决 V5 的几个核心问题：

| 模块 | V5 瓶颈 | V6 进化方案 |
|------|---------|-------------|
| **股票池** | 静态硬编码 (NVDA, META...) | 动态构建 (Quant筛选 + 板块权重) |
| **宏观择时** | 月度轮动，滞后严重 | 事件驱动 (每日分级预警) |
| **防御资产** | 防御板块股票 (XLP, XLU) | 现金避险 (未来可扩展SGOV) |
| **止损机制** | 固定 18% / 10% | ATR 波动率自适应 + 利润锁定 |

### 预期指标 vs 实际结果

| 指标 | 目标 | V6.0 实际 | V6.1 实际 |
|------|------|-----------|-----------|
| 年化收益 | > 25% | ❌ -2.7% | ✅ +17.3% |
| 最大回撤 | < 15% | ❌ 32.7% | ⚠️ 20.5% |
| 夏普比率 | > 1.0 | ❌ -0.20 | ✅ 1.24 |

---

## V6.0 问题诊断

### 5 个核心逻辑漏洞

| 漏洞 | 严重程度 | 表现 | 根因 |
|------|----------|------|------|
| **冷启动空仓** | 🔴 致命 | 2022-2023 两年 0% 收益 | SMA200 需要 200 天数据，回测初期数据不足 |
| **价值陷阱** | 🔴 严重 | 选出 T, CVX, VZ 弱势股 | Quant 评分未区分成长/价值股 |
| **止损过敏** | 🟡 中等 | 127笔交易，胜率仅 39% | ATR 3x 止损在震荡中频繁触发 |
| **熔断失效** | 🟡 中等 | 4年触发 0 次 | VIX>30 阈值过高，且空仓时无意义 |
| **避险缺失** | 🟢 轻微 | Defensive = 100% 现金 | SGOV/BIL 数据库无数据 |

### 影响量化

| 漏洞 | 预估收益损失 |
|------|--------------|
| 冷启动空仓 | -50% (错过 2023 牛市) |
| 价值陷阱 | -20% (持有弱势股) |
| 止损过敏 | -15% (频繁无效止损) |
| 熔断失效 | -5% (2022 未保护) |
| 避险缺失 | -3% (现金 vs 国债) |

---

## V6.1 修复方案

### 修复清单

| 优先级 | 漏洞 | 修复方案 | 代码变更 |
|--------|------|----------|----------|
| **P0** | 冷启动 | 数据不足时回退静态龙头池 | `_build_dynamic_universe()` |
| **P0** | 价值陷阱 | 增加板块权重 + 长期动量评分 | `SECTOR_WEIGHT`, `momentum_score` |
| **P1** | 止损过敏 | ATR 乘数 3x→5x + 最小 12% 距离 | `ATR_MULTIPLIER`, `MIN_STOP_DISTANCE` |
| **P1** | 熔断失效 | 分级预警 watch/caution/danger | `_check_circuit_breaker()` |
| **P2** | 更新频率 | 季度→月度更新龙头池 | 主循环逻辑 |

### 修复 1: 冷启动回退机制

```python
# 当 SMA200 数据不足时，使用静态龙头池
STATIC_TECH_LEADERS = ["NVDA", "META", "GOOGL", "AMZN", "MSFT", "AAPL", "AMD", "AVGO", "NFLX", "TSLA"]

def _build_dynamic_universe(self, dt):
    # ... Quant 筛选逻辑 ...
    
    if data_ready_count < 5:
        # 数据不足，回退静态龙头池
        self._cold_start_months += 1
        return [DynamicLeader(sym, ...) for sym in STATIC_TECH_LEADERS[:6]]
```

### 修复 2: 板块权重 + 长期动量

```python
# 板块权重 - 成长股加分，价值股减分
SECTOR_WEIGHT = {
    "科技": 3, "通讯": 2, "可选消费": 2,   # 成长型
    "金融": 0, "医疗": 1,                  # 中性
    "能源": -1, "公用事业": -2, "必需消费": -1,  # 价值型
}

# 长期动量评分 (60日)
if mom60 > 0.20:
    momentum_score += 3
elif mom60 > 0.10:
    momentum_score += 2
elif mom60 < -0.10:
    momentum_score -= 2  # 长期下跌扣分

# 总分 = Quant + 动量 + 板块
total_score = quant_score + momentum_score + sector_score
```

### 修复 3: 放宽止损 + 最小距离

```python
# ATR 乘数从 3x 放宽到 5x
ATR_MULTIPLIER = {
    "offensive": 5.0,   # 从 3.0 放宽
    "neutral": 4.0,     # 从 2.0 放宽
    "defensive": 2.5,   # 从 1.5 放宽
}

# 新增最小止损距离 12%
MIN_STOP_DISTANCE = 0.12

def _calc_stop_price(self, pos, dt, regime):
    atr_stop = pos.highest_price - (multiplier * current_atr)
    min_stop = pos.highest_price * (1 - MIN_STOP_DISTANCE)
    return min(atr_stop, min_stop)  # 取更宽松的
```

### 修复 4: 分级预警熔断

```python
CIRCUIT_BREAKER = {
    "vix_danger": 28,         # 危险模式
    "vix_caution": 22,        # 警戒模式
    "vix_watch": 20,          # 观察模式
    "vix_rising_fast": 0.20,  # VIX 5日涨幅 > 20%
    "market_crash_pct": 0.02, # 单日跌幅 > 2%
}

# 分级响应
if breaker.level == "danger":
    target_exposure = 0.2   # 只保留 20%
elif breaker.level == "caution":
    target_exposure = 0.4   # 保留 40%
elif breaker.level == "watch":
    target_exposure = 0.6   # 保留 60%
```

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    V6.1 Neuro-Adaptive 系统                  │
├─────────────────────────────────────────────────────────────┤
│  每日分级预警                                                │
│  ├── DANGER: VIX > 28 或 VIX 急升 > 20%                     │
│  ├── CAUTION: VIX > 22 + 上升趋势 或 SPY < SMA200           │
│  ├── WATCH: VIX > 20 + 上升趋势                             │
│  └── NORMAL: 正常交易                                        │
│       ↓                                                      │
├─────────────────────────────────────────────────────────────┤
│  宏观状态评分 (每日)                                         │
│  ├── VIX 评分 (-2 ~ +2)                                     │
│  ├── SPY 趋势评分 (-2 ~ +2)                                 │
│  └── VIX 趋势 (-1 ~ +1)                                     │
│       ↓                                                      │
│  score >= 2 → Offensive (100%)                               │
│  score >= 0 → Neutral (70%)                                  │
│  score < 0 → Defensive (40%)                                 │
├─────────────────────────────────────────────────────────────┤
│  动态龙头池 (月度更新)                                       │
│  ├── 冷启动检查: 数据不足 → 静态龙头池                       │
│  ├── Quant 初筛: 价格>SMA50, RSI>40, 动量>0                 │
│  ├── 长期动量: 60日涨幅权重                                  │
│  ├── 板块权重: 科技+3, 通讯+2, 能源-1...                    │
│  └── 板块分散: 每板块最多 3 只                               │
├─────────────────────────────────────────────────────────────┤
│  交易执行 (每5天)                                            │
│  ├── ATR 自适应止损 (5x 乘数 + 12% 最小距离)                 │
│  ├── 利润锁定: 15%→保本, 30%→锁90%                          │
│  └── 再平衡组合                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 回测结果对比

### V6.0 vs V6.1 (4年回测: 2022-01 ~ 2026-01)

| 指标 | V6.0 原版 | V6.1 修复版 | 改进幅度 |
|------|-----------|-------------|----------|
| **总收益率** | -10.60% | **+90.38%** | **+100.98%** |
| **年化收益** | -2.74% | **+17.28%** | **+20.02%** |
| **Alpha** | -92.27% | **+8.70%** | **+100.97%** |
| **最大回撤** | 32.68% | **20.48%** | **-12.20%** |
| **夏普比率** | -0.20 | **1.24** | **+1.44** |
| **胜率** | 38.9% | **54.1%** | **+15.2%** |
| **盈亏比** | 0.85 | **1.85** | **+1.00** |
| **交易次数** | 126 | 98 | -28 |

### 年度收益分解

| 年份 | V6.0 | V6.1 | SPY | V6.1 Alpha |
|------|------|------|-----|------------|
| 2022 | 0.0% | 0.0% | +0.4% | -0.4% |
| 2023 | **0.0%** | **+29.2%** | +24.8% | **+4.4%** |
| 2024 | +5.2% | **+24.4%** | +24.0% | +0.4% |
| 2025 | -14.0% | **+17.1%** | +16.6% | +0.5% |
| 2026 | -2.2% | **+2.6%** | +1.2% | +1.4% |

### 与其他策略对比

| 策略 | 收益率 | 回撤 | 夏普 | 特点 | 推荐场景 |
|------|--------|------|------|------|----------|
| **V3 趋势跟踪** | +117% | 16% | 1.32 | 简单有效 | 追求最高收益 |
| **V5 融合策略** | +90% | 12.5% | 1.43 | 风控最优 | 追求最低回撤 |
| **V6.1 修复版** | +90% | 20.5% | 1.24 | 动态龙头池 | 追求智能选股 |
| ~~V6.0 原版~~ | -11% | 33% | -0.20 | 逻辑漏洞 | ❌ 已废弃 |

### 熔断事件统计 (V6.1)

| 级别 | 触发次数 | 示例事件 |
|------|----------|----------|
| DANGER | 9 | VIX急升103% (2025-01), SPY暴跌-2.3% (2024-08) |
| CAUTION | 1 | SPY跌破SMA200 (2023-11) |
| WATCH | 4 | VIX观察22.9 (2023-01) |

### Top 盈利交易 (V6.1)

| 日期 | 股票 | 盈亏 | 收益率 | 原因 |
|------|------|------|--------|------|
| 2025-11-04 | INTC | **+$12,134** | +50.5% | 止损触发 |
| 2025-08-06 | ORCL | +$11,416 | +44.8% | 轮出龙头池 |
| 2024-12-20 | TSLA | +$10,867 | +45.9% | 止损触发 |
| 2024-06-24 | NVDA | +$10,218 | +42.9% | 止损触发 |
| 2023-08-09 | NVDA | +$9,622 | +60.8% | 止损触发 |

---

## 核心组件详解

### 1. 动态龙头池构建

```python
def _build_dynamic_universe(self, dt) -> List[DynamicLeader]:
    """
    每月更新龙头池
    
    评分公式:
    total_score = quant_score + momentum_score + sector_score
    
    quant_score (0-6):
      - 价格 > SMA200: +2 (或 > SMA50: +1)
      - RSI > 40: +1
      - 20日动量 > 8%: +2 (或 > 2%: +1)
    
    momentum_score (-2 ~ +5):
      - 60日动量 > 20%: +3
      - 60日动量 > 10%: +2
      - 相对强度 vs SPY > 15%: +2
      - 长期下跌 < -10%: -2
    
    sector_score (-2 ~ +3):
      - 科技: +3, 通讯: +2, 可选消费: +2
      - 金融: 0, 医疗: +1
      - 能源: -1, 公用事业: -2
    """
```

### 2. 分级预警熔断器

```python
def _check_circuit_breaker(self, dt) -> CircuitBreakerState:
    """
    分级预警系统
    
    DANGER (仓位 20%):
      - VIX > 28
      - VIX 5日涨幅 > 20% 且 VIX > 22
      - SPY 单日跌幅 > 2%
    
    CAUTION (仓位 40%):
      - VIX > 22 + 上升趋势 > 10%
      - SPY 跌破 SMA200 的 98%
    
    WATCH (仓位 60%):
      - VIX > 20 + 上升趋势 > 5%
    
    冷却期:
      - DANGER: 10天
      - CAUTION: 5天
      - WATCH: 3天
    
    恢复条件:
      - VIX < 18 且 SPY > SMA50
    """
```

### 3. ATR 自适应止损

```python
def _calc_stop_price(self, pos, dt, regime) -> float:
    """
    动态止损计算
    
    1. ATR 止损:
       stop = highest_price - (ATR × multiplier)
       multiplier: offensive=5.0, neutral=4.0, defensive=2.5
    
    2. 最小止损距离:
       min_stop = highest_price × (1 - 0.12)
       final = min(atr_stop, min_stop)  # 取更宽松的
    
    3. 利润锁定:
       if pnl >= 30%: stop = max(stop, highest × 0.90)
       if pnl >= 15%: stop = max(stop, cost × 1.02)
    """
```

---

## 使用指南

### 运行回测

```bash
cd /Users/bobbylai/Programs/trader
source .venv/bin/activate
set -a && source .env && set +a

# 运行 V6.1 回测 (推荐)
PYTHONPATH=. python scripts/run_backtest_v6_1.py

# 对比 V3 回测
PYTHONPATH=. python scripts/run_backtest_v3.py

# 对比 V5 回测
PYTHONPATH=. python scripts/run_backtest_v5.py
```

### 输出文件

| 文件 | 说明 |
|------|------|
| `storage/backtest_v6_1/result.json` | 回测结果汇总 |
| `storage/backtest_v6_1/trades.json` | 交易记录 |
| `storage/backtest_v6_1/equity_curve.csv` | 净值曲线 |
| `storage/backtest_v6_1/macro_history.json` | 宏观状态历史 |
| `storage/backtest_v6_1/leader_history.json` | 龙头池更新历史 |

### 参数调优建议

| 参数 | 当前值 | 调优方向 |
|------|--------|----------|
| `ATR_MULTIPLIER["offensive"]` | 5.0 | 放宽到 6.0 可减少止损 |
| `MIN_STOP_DISTANCE` | 0.12 | 放宽到 0.15 可减少止损 |
| `CIRCUIT_BREAKER["vix_danger"]` | 28 | 降低到 25 可更早避险 |
| `SECTOR_WEIGHT["科技"]` | 3 | 提高到 4 可更聚焦科技股 |

---

## 总结

### V6.1 核心优势

1. **动态选股**: 月度更新龙头池，避免静态池的滞后性
2. **分级风控**: watch/caution/danger 三级预警，渐进式减仓
3. **智能止损**: ATR 自适应 + 最小距离保护，平衡灵活与安全
4. **冷启动保护**: 数据不足时自动回退静态池，避免空仓

### 适用场景

- **适合**: 希望使用量化方法动态筛选龙头股的投资者
- **不适合**: 追求极致收益 (用 V3) 或极致风控 (用 V5) 的投资者

### 后续优化方向

1. 导入 SGOV/BIL 数据，实现真·避险资产配置
2. 增加 LLM 叙事验证，过滤技术面良好但基本面恶化的股票
3. 优化板块权重，支持动态调整

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `scripts/run_backtest_v6_1.py` | V6.1 回测脚本 (推荐) |
| `scripts/run_backtest_v6.py` | V6.0 回测脚本 (已废弃) |
| `storage/backtest_v6_1/` | V6.1 回测结果 |
| `storage/backtest_v6/` | V6.0 回测结果 (仅供对比) |

---

*文档更新日期: 2026-01-21*

*AI Trader Assist Project*
