# V5 融合策略完整指南

> **V3 趋势跟踪 + V4 分层决策 的融合版本**
>
> 3年回测收益: **+90.43%** | Alpha: **+8.80%** | 夏普比率: **1.43** | 最大回撤: **12.56%**

---

## 目录

1. [策略概览](#策略概览)
2. [三层决策框架](#三层决策框架)
3. [第一层：宏观趋势分析](#第一层宏观趋势分析)
4. [第二层：板块轮动](#第二层板块轮动)
5. [第三层：个股选择](#第三层个股选择)
6. [止损规则](#止损规则)
7. [仓位管理](#仓位管理)
8. [回测结果](#回测结果)
9. [策略对比](#策略对比)
10. [执行要点](#执行要点)

---

## 策略概览

### 策略定位

V5 融合策略是 **V3 趋势跟踪** 与 **V4 分层决策** 的融合版本，目标是：

- 收益接近 V3 (+100%+)
- 回撤控制在 15% 以内

### 核心改进

| 改进项 | V4 原版 | V5 优化 |
|--------|---------|---------|
| 进攻阈值 | score ≥ 3 | score ≥ 2 |
| 板块持有周期 | 周度 | 双周 |
| 跟踪止损 | 15% | 18% |
| 止盈 | 开启 | 禁用 |
| neutral 仓位档位 | 3档 (50%/60%/70%) | 1档 (70%) |

### 继承的 V3 优点

- ✅ 科技龙头聚焦
- ✅ 宽松止损 (18%)
- ✅ 禁用止盈 (让利润奔跑)

### 融合的 V4 框架

- ✅ 宏观 → 板块 → 个股 三层决策
- ✅ 动态仓位调整 (30%-95%)
- ✅ 板块轮动分散风险

### 科技龙头池

```
NVDA | META | GOOGL | AMZN | MSFT | AAPL | AMD | AVGO | NFLX | TSLA
```

### 适用场景

| 场景 | 适用性 |
|------|--------|
| 保守型投资者 | ✅ 适合 |
| 震荡市场环境 | ✅ 适合 |
| 追求稳健风险调整收益 | ✅ 适合 |
| 激进型投资者 | ⚠️ 建议使用 V3 |
| 牛市环境 | ⚠️ V3 收益更高 |

---

## 三层决策框架

```
┌─────────────────────────────────────────────────────────────┐
│  第一层: 宏观趋势分析 (月度更新)                              │
│  ────────────────────────────────────────────────────────── │
│  输入: VIX、SPY动量、新闻情绪                                 │
│  输出: offensive / neutral / defensive                      │
│  决定: 目标仓位 (95% / 70% / 30%)                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第二层: 板块轮动 (双周更新)                                  │
│  ────────────────────────────────────────────────────────── │
│  输入: 11个板块ETF动量                                       │
│  输出: Top 2-4 强势板块                                      │
│  公式: 0.5×mom20 + 0.25×RS + 0.15×mom5 + 0.1×sentiment      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第三层: 个股选择 (每5天再平衡)                               │
│  ────────────────────────────────────────────────────────── │
│  offensive: 优先科技龙头 (Top 6)                             │
│  neutral/defensive: 板块内选股 (每板块 Top 2)                │
│  评分: 0.6×mom20 + 0.3×mom5 + 成交量加分                     │
└─────────────────────────────────────────────────────────────┘
```

### 运行频率总结

| 层级 | 更新频率 |
|------|----------|
| 宏观分析 | 月度 |
| 板块轮动 | 双周 |
| 止损检查 | 每日 |
| 再平衡 | 每5天 |

---

## 第一层：宏观趋势分析

### 评分规则

#### VIX 评分

| 条件 | 分数 | 状态 |
|------|------|------|
| VIX < 18 | +2 | 低位 (贪婪) |
| 18 ≤ VIX < 22 | +1 | 正常 |
| 22 ≤ VIX < 30 | -1 | 偏高 (谨慎) |
| VIX ≥ 30 | -2 | 恐慌 |

#### SPY 动量评分

| 条件 | 分数 | 状态 |
|------|------|------|
| SPY > SMA50 且 mom20 > 2% | +2 | 强势上涨 |
| SPY > SMA50 | +1 | 均线上方 |
| SPY < SMA50 且 mom20 < -5% | -2 | 弱势下跌 |
| 其他 | 0 | 中性 |

#### 新闻情绪评分

| 条件 | 分数 |
|------|------|
| sentiment > 0.2 | +1 |
| sentiment < -0.3 | -1 |

### 市场状态判定

| 总分 | 状态 | 目标仓位 | 说明 |
|------|------|----------|------|
| ≥ 2 | **offensive** (进攻) | 95% | 全力进攻 |
| 0 ~ 1 | **neutral** (中性) | 70% | 稳健配置 |
| < 0 | **defensive** (防御) | 30% | 保守防守 |

### 代码实现

```python
def _analyze_macro(self, dt: date) -> MacroView:
    vix = self._get('VIX', dt, 'close') or 20
    spy_mom = self._get('SPY', dt, 'mom20') or 0
    spy_close = self._get('SPY', dt, 'close') or 0
    spy_sma50 = self._get('SPY', dt, 'sma50') or spy_close
    
    score = 0
    
    # VIX 评分
    if vix < 18:
        score += 2
    elif vix < 22:
        score += 1
    elif vix < 30:
        score -= 1
    else:
        score -= 2
    
    # SPY 动量评分
    if spy_close > spy_sma50 and spy_mom > 0.02:
        score += 2
    elif spy_close > spy_sma50:
        score += 1
    elif spy_close < spy_sma50 and spy_mom < -0.05:
        score -= 2
    
    # 市场状态判定 (V5 放宽阈值)
    if score >= 2:
        regime = "offensive"
        target_exposure = 0.95
    elif score >= 0:
        regime = "neutral"
        target_exposure = 0.70
    else:
        regime = "defensive"
        target_exposure = 0.30
    
    return MacroView(regime=regime, target_exposure=target_exposure, score=score)
```

---

## 第二层：板块轮动

### 板块配置

```python
SECTOR_STOCKS = {
    "XLK": ["AAPL", "MSFT", "NVDA", "AVGO", "AMD", "ADBE", "CRM", "ORCL", "CSCO", "INTC"],  # 科技
    "XLC": ["META", "GOOGL", "GOOG", "NFLX", "DIS", "CMCSA", "T", "VZ", "TMUS"],            # 通讯
    "XLY": ["AMZN", "TSLA", "HD", "MCD", "NKE", "SBUX", "LOW", "TJX", "TGT"],               # 可选消费
    "XLF": ["JPM", "BAC", "WFC", "GS", "MS", "BLK", "C", "AXP", "SCHW", "PNC"],             # 金融
    "XLV": ["UNH", "JNJ", "LLY", "PFE", "MRK", "ABBV", "TMO", "ABT", "DHR", "BMY"],         # 医疗
    "XLE": ["XOM", "CVX", "COP", "EOG", "SLB", "MPC", "PSX", "VLO", "OXY"],                 # 能源
    "XLI": ["CAT", "UNP", "HON", "UPS", "BA", "RTX", "DE", "LMT", "GE", "FDX"],             # 工业
    "XLP": ["PG", "KO", "PEP", "COST", "WMT", "PM", "MO"],                                  # 必需消费
    "XLU": ["NEE", "DUK", "SO", "D", "AEP"],                                                # 公用事业
    "XLB": ["LIN", "APD", "SHW", "ECL", "DD"],                                              # 材料
    "XLRE": ["AMT", "PLD", "CCI", "EQIX", "SPG"],                                           # 房地产
}

DEFENSIVE_SECTORS = ["XLP", "XLV", "XLU"]  # 防御板块
GROWTH_SECTORS = ["XLK", "XLC", "XLY"]     # 成长板块
```

### 板块评分公式

```
板块得分 = 0.5 × mom20 + 0.25 × RS_vs_SPY + 0.15 × mom5 + 0.1 × 新闻情绪
```

其中：
- `mom20`: 20日动量
- `RS_vs_SPY`: 相对 SPY 的强度 (mom20 - SPY_mom20)
- `mom5`: 5日动量
- `新闻情绪`: 板块内股票的平均新闻情绪

### 板块数量选择

| 市场状态 | 选择板块数 | 说明 |
|----------|------------|------|
| offensive | Top 4 | 分散在多个成长板块 |
| neutral | Top 3 | 适度分散 |
| defensive | Top 2 | 聚焦防御板块 |

### 状态偏好调整

```python
# defensive 模式偏好防御板块
if macro.market_regime == "defensive":
    for s in DEFENSIVE_SECTORS:
        sector_scores[s] += 0.05
    for s in GROWTH_SECTORS:
        sector_scores[s] -= 0.03

# offensive 模式偏好成长板块
elif macro.market_regime == "offensive":
    for s in GROWTH_SECTORS:
        sector_scores[s] += 0.05
```

---

## 第三层：个股选择

### 科技龙头优先 (offensive 模式)

```python
TECH_LEADERS = ["NVDA", "META", "GOOGL", "AMZN", "MSFT", "AAPL", "AMD", "AVGO", "NFLX", "TSLA"]
```

#### 筛选条件 (放宽版)

| 条件 | 说明 |
|------|------|
| 价格 > SMA50 × 0.95 | 允许 5% 容忍度 |
| mom20 > -5% | 只过滤明显下跌的 |

#### 评分公式

```
个股得分 = 0.6 × mom20 + 0.3 × mom5 + 成交量加分
```

其中：
- 成交量加分: vol_ratio > 1.2 时 +0.03

### 板块内选股 (所有模式)

#### 筛选条件

| 条件 | 说明 |
|------|------|
| 价格 > SMA20 | 短期趋势向上 |
| mom20 > 0 | 中期动量为正 |

#### 评分公式

```
个股得分 = 0.5 × mom20 + 0.3 × mom5 + 成交量加分
```

### 选股数量

| 来源 | 数量 |
|------|------|
| 科技龙头 (offensive) | Top 6 |
| 每个板块 | Top 2 |

### 选股逻辑流程

```
if offensive 模式:
    1. 从 TECH_LEADERS 筛选符合条件的股票
    2. 按评分排序，取 Top 6
    3. 补充板块轮动股票 (去重)
else:
    1. 在选定板块内筛选符合条件的股票
    2. 每板块取 Top 2
```

---

## 止损规则

### 止损类型

| 类型 | 条件 | 动作 |
|------|------|------|
| **跟踪止损** | 从最高点回撤 > 18% | 卖出 |
| **防御模式硬止损** | 价格 < 成本 × 0.90 | 卖出 |
| **趋势破坏** | 价格 < SMA50 × 0.92 且 mom20 < -10% | 卖出 |
| **止盈** | ❌ **禁用** | 让利润奔跑 |

### 代码实现

```python
def _check_stops(self, dt: date, macro: MacroView):
    for sym, pos in self.positions.items():
        price = self._get(sym, dt, 'close')
        pos.highest_price = max(pos.highest_price, price)
        
        drawdown = (pos.highest_price - price) / pos.highest_price
        
        # 跟踪止损 18%
        if drawdown > 0.18:
            self._sell(sym, dt, f"跟踪止损({drawdown:.1%})")
            continue
        
        # 防御模式硬止损 10%
        if macro.market_regime == "defensive":
            if price < pos.avg_cost * 0.90:
                self._sell(sym, dt, "防御模式止损")
                continue
        
        # 趋势破坏
        sma50 = self._get(sym, dt, 'sma50')
        mom20 = self._get(sym, dt, 'mom20')
        if sma50 and price < sma50 * 0.92 and mom20 and mom20 < -0.10:
            self._sell(sym, dt, "趋势破坏")
```

### 为什么禁用止盈？

| 止盈 | 问题 |
|------|------|
| 开启止盈 | 在牛市中过早卖出，错过大部分涨幅 |
| 禁用止盈 | 让利润奔跑，通过跟踪止损保护利润 |

V3 回测证明，禁用止盈 + 宽松跟踪止损是最优组合。

---

## 仓位管理

### 最大持仓数

| 市场状态 | 最大持仓数 | 单只仓位 |
|----------|------------|----------|
| offensive | 6 只 | ~16% |
| neutral | 5 只 | ~14% |
| defensive | 5 只 | ~14% |

### 再平衡逻辑 (每5天)

#### 需要减仓时 (defensive 且 exposure > target + 10%)

```python
# 卖出表现最差的持仓
holdings = sorted(positions, key=lambda x: pnl_pct)
for sym in holdings:
    if current_exposure <= target_exposure + 0.1:
        break
    self._sell(sym, dt, "防御减仓")
```

#### 需要加仓时 (exposure < target - 10%)

```python
# 按候选股评分买入
for sym, sector, score, source in candidates:
    if len(positions) >= max_positions:
        break
    if sym in positions:
        continue
    budget = min(pv * position_pct, available)
    self._buy(sym, sector, source, dt, budget, reason)
```

### 关键原则

1. **不因板块轮出卖出**: 只在止损触发时卖出
2. **优先卖亏损最大的**: 减仓时先卖表现最差的
3. **按评分买入**: 加仓时按候选股评分排序

---

## 回测结果

### 回测参数

| 参数 | 值 |
|------|------|
| 回测区间 | 2023-01-03 ~ 2026-01-16 |
| 初始资金 | $100,000 |
| 交易日数 | 763 天 |

### 核心指标

| 指标 | 数值 |
|------|------|
| **最终价值** | $190,429 |
| **总收益率** | +90.43% |
| **年化收益** | +23.61% |
| **SPY 收益** | +81.62% |
| **Alpha** | +8.80% |
| **最大回撤** | 12.56% |
| **夏普比率** | 1.43 |
| **胜率** | 34.5% |
| **盈亏比** | 2.47 |
| **总交易** | 64 笔 |
| **平均盈利** | $8,604 |
| **平均亏损** | -$1,836 |

### 宏观状态分布

| 状态 | 月数 | 占比 |
|------|------|------|
| offensive (进攻) | 30 | 81% |
| neutral (中性) | 5 | 14% |
| defensive (防御) | 2 | 5% |

### 交易来源分布

| 来源 | 买入笔数 | 占比 |
|------|----------|------|
| tech_leader | 14 | 40% |
| sector_rotation | 21 | 60% |

### 板块交易分布

| 板块 | 交易笔数 |
|------|----------|
| XLK (科技) | 9 |
| XLY (可选消费) | 8 |
| XLC (通讯) | 7 |
| XLP (必需消费) | 4 |
| XLV (医疗) | 4 |
| XLE (能源) | 3 |

### Top 5 盈利交易

| 日期 | 股票 | 盈亏 | 收益率 | 原因 |
|------|------|------|--------|------|
| 2023-09-21 | NVDA | +$15,477 | +95.9% | 趋势破坏 |
| 2025-12-17 | AVGO | +$13,889 | +69.4% | 跟踪止损 |
| 2025-03-13 | COST | +$11,192 | +81.4% | 趋势破坏 |
| 2024-04-04 | AMD | +$9,686 | +53.8% | 跟踪止损 |
| 2025-07-24 | PM | +$7,784 | +55.8% | 趋势破坏 |

### Top 5 亏损交易

| 日期 | 股票 | 盈亏 | 收益率 | 原因 |
|------|------|------|--------|------|
| 2024-06-12 | VLO | -$4,446 | -19.1% | 跟踪止损 |
| 2024-07-25 | AVGO | -$4,372 | -18.4% | 跟踪止损 |
| 2025-10-10 | NKE | -$3,478 | -13.5% | 趋势破坏 |
| 2025-04-08 | ABBV | -$3,430 | -17.0% | 跟踪止损 |
| 2023-10-27 | VLO | -$2,911 | -15.5% | 趋势破坏 |

### 净值曲线

```
$200k ┤                                                    ╭──
      │                                               ╭────╯
$180k ┤                                          ╭────╯
      │                                     ╭────╯
$160k ┤                                ╭────╯
      │                           ╭────╯
$140k ┤                      ╭────╯
      │                 ╭────╯
$120k ┤            ╭────╯
      │       ╭────╯
$100k ┼───────╯
      └─────────────────────────────────────────────────────→
        2023-01          2024-01          2025-01      2026-01
        
        ── V5 策略    ── SPY 基准
```

### 回撤曲线

```
   0% ┼───╮  ╭─╮  ╭──╮         ╭╮ ╭──╮         ╭─╮
      │   ╰──╯ ╰──╯  ╰─────────╯╰─╯  ╰─────────╯ ╰────
  -5% ┤
      │
 -10% ┤
      │                               ▼ 最大回撤 12.56%
 -15% ┤
      └─────────────────────────────────────────────────────→
        2023-01          2024-01          2025-01      2026-01
```

---

## 策略对比

### V3 vs V5 详细对比

| 维度 | V3 趋势跟踪 | V5 融合策略 |
|------|-------------|-------------|
| **选股范围** | 只有科技龙头 | 科技龙头 + 板块轮动 |
| **仓位控制** | 固定 95% | 动态 30%-95% |
| **止损** | 15% 跟踪止损 | 18% 跟踪止损 |
| **决策频率** | 每周 | 月度+双周+每5天 |
| **总收益** | **+117.02%** | +90.43% |
| **年化收益** | **+29.05%** | +23.61% |
| **Alpha** | **+35.40%** | +8.80% |
| **最大回撤** | 16.10% | **12.56%** |
| **夏普比率** | 1.32 | **1.43** |

### 策略选择建议

| 目标 | 推荐策略 | 理由 |
|------|----------|------|
| **追求最高收益** | V3 趋势跟踪 | +117% 收益, Alpha +35.4% |
| **追求最低回撤** | V5 融合策略 | 12.56% 回撤, 夏普 1.43 |
| **追求最优平衡** | V5 融合策略 | 风险调整后收益最优 |

### V5 核心优势

1. ✅ **最低回撤 (12.56%)** - 心理压力更小
2. ✅ **最高夏普比率 (1.43)** - 风险调整后收益最优
3. ✅ **分层决策框架** - 逻辑清晰，易于理解和执行
4. ✅ **动态仓位管理** - 根据市场状态自动调整

---

## 执行要点

### 月度检查清单

```
□ 检查 VIX 水平
□ 检查 SPY 是否在 SMA50 之上
□ 检查 SPY 20日动量
□ 计算宏观评分
□ 确定市场状态 (offensive/neutral/defensive)
□ 设定目标仓位
```

### 双周检查清单

```
□ 计算 11 个板块 ETF 的动量
□ 计算相对 SPY 的强度
□ 评估板块新闻情绪
□ 选出 Top 2-4 强势板块
```

### 每日检查清单

```
□ 检查持仓是否触发跟踪止损 (18%)
□ 检查持仓是否触发趋势破坏
□ 如果 defensive 模式，检查硬止损 (10%)
```

### 每5天检查清单

```
□ 评估当前仓位 vs 目标仓位
□ 如需减仓，卖出表现最差的持仓
□ 如需加仓，按候选股评分买入
□ 确保持仓数不超过上限
```

### 核心原则

1. **趋势为王**: 只在 SPY > SMA50 时大举进攻
2. **科技龙头优先**: offensive 模式聚焦 TECH_LEADERS
3. **让利润奔跑**: 禁用止盈，使用宽松的 18% 跟踪止损
4. **动态仓位**: 根据宏观状态灵活调整 (30%-95%)
5. **分散风险**: 板块轮动 + 科技龙头双轨制

---

## 风险提示

⚠️ **本策略仅供研究参考，不构成投资建议**

⚠️ **回测结果不代表未来收益**

⚠️ **实盘需考虑滑点、手续费、流动性等因素**

⚠️ **请在人工复核后执行所有交易**

---

## 附录

### 运行回测

```bash
cd /Users/bobbylai/Programs/trader
source .venv/bin/activate
PYTHONPATH=. python scripts/run_backtest_v5.py
```

### 生成培训 PDF

```bash
PYTHONPATH=. python scripts/generate_v5_training_pdf.py
open storage/V5_Strategy_Training.pdf
```

### 相关文件

| 文件 | 说明 |
|------|------|
| `scripts/run_backtest_v5.py` | V5 回测脚本 |
| `scripts/generate_v5_training_pdf.py` | PDF 生成脚本 |
| `storage/backtest_3y_v5/result.json` | 回测结果 |
| `storage/backtest_3y_v5/trades.json` | 交易记录 |
| `storage/backtest_3y_v5/equity_curve.csv` | 净值曲线 |
| `storage/backtest_3y_v5/macro_history.json` | 宏观状态历史 |
| `storage/V5_Strategy_Training.pdf` | 培训文档 |

---

*文档生成日期: 2026-01-21*

*AI Trader Assist Project*
